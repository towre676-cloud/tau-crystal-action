name: "tau-crystal-action"
description: "Receipt-first, Merkle-rooted attestation via pure bash (Lean optional via elan)."
author: "towre676-cloud"
branding:
  icon: shield
  color: purple

inputs:
  working-directory:
    description: "Path to verify"
    required: false
    default: "."
  install-elan:
    description: "Install Lean toolchain with elan"
    required: false
    default: "true"

outputs:
  verifier:
    description: "Absolute path to bundled verifier script"
    value: ${{ steps.expose.outputs.verifier }}
  receipt:
    description: "Latest receipt JSON path"
    value: ${{ steps.outs.outputs.receipt }}
  chain-head:
    description: "CHAIN head (sha256)"
    value: ${{ steps.outs.outputs.head }}
  merkle-root:
    description: "Manifest merkle root"
    value: ${{ steps.outs.outputs.root }}

runs:
  using: "composite"
  steps:
    - id: expose
      shell: bash
      run: |
        set -euo pipefail
        v="$GITHUB_ACTION_PATH/verify/verify-receipt.sh"
        chmod +x "$v" || true
        echo "verifier=$v" >> "$GITHUB_OUTPUT"

    - name: Install elan (optional)
      if: ${{ inputs.install-elan == 'true' }}
      shell: bash
      run: |
        set +H; umask 022
        curl -sSfL https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh | sh -s -- -y
        echo "$HOME/.elan/bin" >> "$GITHUB_PATH"

    - name: Verify with tau-crystal
      shell: bash
      env:
        ACTION_DIR: ${{ github.action_path }}
      working-directory: ${{ inputs.working-directory }}
      run: |
        set +H; umask 022
        if [ -x "$ACTION_DIR/scripts/tau_verify.sh" ]; then bash "$ACTION_DIR/scripts/tau_verify.sh"; fi
        if [ -x "$ACTION_DIR/scripts/spec_guard.sh" ]; then bash "$ACTION_DIR/scripts/spec_guard.sh" || true; fi
        if [ -s ".tau_ledger/signals/observable.tsv" ] && [ -x "$ACTION_DIR/scripts/tau_adapter.sh" ]; then
          bash "$ACTION_DIR/scripts/tau_adapter.sh" .tau_ledger/signals/observable.tsv || true
        fi

    - name: Record wrapper digest
      shell: bash
      env:
        ACTION_DIR: ${{ github.action_path }}
      working-directory: ${{ inputs.working-directory }}
      run: |
        set +H; umask 022
        mkdir -p .tau_ledger
        bash "$ACTION_DIR/scripts/bin/hash_action_wrapper.sh" "${{ inputs.working-directory }}"

    - name: Ensure receipt (fallback)
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        set -euo pipefail; set +H; umask 022
        mkdir -p .tau_ledger
        rcpt=.tau_ledger/receipt.json
        head=$(git rev-parse HEAD)
        # wrapper digest from prior step (or compute as last resort)
        if [ -s .tau_ledger/action_wrapper.sha256 ]; then
          wrap=$(awk "{print \$1}" .tau_ledger/action_wrapper.sha256)
        else
          wrap=$(sha256sum "$GITHUB_ACTION_PATH/action.yml" | awk '{print $1}')
        fi
        # ensure manifest has merkle_root and action_wrapper_sha
        if [ -f tau-crystal-manifest.json ]; then
          if command -v jq >/dev/null 2>&1; then
            tmp=$(mktemp)
            jq ". + {action_wrapper_sha: \"$wrap\"}" tau-crystal-manifest.json > "$tmp" && mv "$tmp" tau-crystal-manifest.json
          else
            if ! grep -q 'action_wrapper_sha' tau-crystal-manifest.json; then
              root=$(grep -oE '"merkle_root"[[:space:]]*:[[:space:]]*"[^"]*"' tau-crystal-manifest.json | sed -E 's/.*:"([^"]*)".*/\1/')
              printf '{"merkle_root":"%s","action_wrapper_sha":"%s"}
' "$root" "$wrap" > tau-crystal-manifest.json
            fi
          fi
        else
          # compute a coarse root if manifest is missing
          root=$(git ls-files -z | sort -z | xargs -0 sha256sum | awk '{print $1}' | tr -d "\n" | sha256sum | awk '{print $1}')
          printf '{"merkle_root":"%s","action_wrapper_sha":"%s"}
' "$root" "$wrap" > tau-crystal-manifest.json
        fi
        # write a minimal receipt the enforcer can consume
        root_val=$(grep -oE '"merkle_root"[[:space:]]*:[[:space:]]*"[^"]*"' tau-crystal-manifest.json | sed -E 's/.*:"([^"]*)".*/\1/')
        printf '{"chain_head":"%s","merkle_root":"%s","action_wrapper_sha":"%s"}
' "$head" "$root_val" "$wrap" > "$rcpt"
        printf '%s %s
' "$head" "$rcpt" > .tau_ledger/CHAIN
    - name: Enforce wrapper digest (required)
      shell: bash
      env:
        ACTION_DIR: ${{ github.action_path }}
      working-directory: ${{ inputs.working-directory }}
      run: |
        set -Eeuo pipefail; set +H; umask 022
        bash "$ACTION_DIR/scripts/bin/enforce_wrapper_digest.sh" "${{ inputs.working-directory }}"

    - name: Collect outputs
      id: outs
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        set -Eeuo pipefail; set +H; umask 022
        rcpt=""; head=""; root=""
        if [ -f .tau_ledger/CHAIN ]; then
          rcpt=$(awk '{print $2}' .tau_ledger/CHAIN | tail -n1 || true)
          head=$(awk '{print $1}' .tau_ledger/CHAIN | tail -n1 || true)
        fi
        [ -z "$rcpt" ] && rcpt=$(ls -1t .tau_ledger/*.json 2>/dev/null | head -n1 || true)
        if [ -f tau-crystal-manifest.json ]; then
          root=$(grep -oE '"merkle_root"[[:space:]]*:[[:space:]]*"[^"]*"' tau-crystal-manifest.json \
                 | sed -E 's/.*:"([^"]*)".*/\1/' | head -n1 || true)
        fi
        echo "receipt=$rcpt" >> "$GITHUB_OUTPUT"
        echo "head=$head"     >> "$GITHUB_OUTPUT"
        echo "root=$root"     >> "$GITHUB_OUTPUT"
